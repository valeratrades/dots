exec systemctl --user import-environment
exec dbus-update-activation-environment --systemd WAYLAND_DISPLAY XDG_CURRENT_DESKTOP=sway
exec /usr/lib/xdg-desktop-portal -r & exec /usr/lib/xdg-desktop-portal-wlr
exec mkdir -p ~/tmp/Screenshots

set $mod Mod4
# Rofi
set $wifi ~/.config/rofi/modi/nmcli
set $menu rofi -m $(expr $(swaymsg -t get_tree | jq '.nodes | map([recurse(.nodes[]?, .floating_nodes[]?) | .focused] | any) | index(true)') - 1) -show drun -run-command 'swaymsg exec -- {cmd}'
#
set $output_laptop "eDP-1"
set $output_monitor "HDMI-A-1"
# sway circles through this space-delimited list when the first element is not found.
set $primary "HDMI-A-1" "eDP-1"



set $left s
set $down r
set $up n
set $right t

font pango:Sans 6
titlebar_padding 1 1
titlebar_border_thickness 1
focus_on_window_activation none
for_window [class="discord"] focus=off
for_window [class="Zulip"] focus=off
for_window [app_id="org.telegram.desktop"] focus=off
focus_follows_mouse yes
mouse_warping container
default_border pixel 1
smart_gaps off
gaps inner 0
xwayland enable
smart_borders off
hide_edge_borders both

bindgesture pinch:outward exec xdotool key ctrl+plus
bindgesture pinch:inward exec xdotool key ctrl+minus

# # Autostart
exec "bash -c 'ps -u $USER -o pid= > /tmp/sway_existing_pids.txt'"
#exec "~/.config/sway/listen.sh"

exec mako
exec libinput-gestures
exec wlr-gamma-service
exec keyd-application-mapper -d
exec bluetoothctl
exec pipewire
exec pipewire-pulse
exec wireplumber
exec greenclip daemon>/dev/null
bindsym $mod+g exec rofi -modi "clipboard:greenclip print" -show clipboard
bindsym $mod+Shift+g exec greenclip clear
#

input * {
    xkb_layout "semimak,ru"
    xkb_variant "my,my"
		xkb_options "grp:win_space_toggle"

    natural_scroll enabled
    tap enabled
    scroll_factor 1.43

    repeat_delay 130
    repeat_rate 70
}
## Here it is fed by keyd. Done so I can use Alt+Shift in other keybinds
## to get the code of the key, use xev or auto-hotkey
#bindcode Mod1+Shift+52 input type:keyboard xkb_switch_layout next

# # Multimedia
exec_always pamixer --default-source --set-volume 30
exec_always pamixer --set-volume 45
bindsym $mod+F5 exec pamixer --toggle-mute
bindsym $mod+F6 exec pamixer --decrease 5
bindsym $mod+F7 exec pamixer --increase 5
bindsym $mod+F8 exec pamixer --default-source -t
bindsym $mod+Shift+F6 exec pamixer --default-source --decrease 5
bindsym $mod+Shift+F7 exec pamixer --default-source --increase 5
bindsym XF86AudioPlay exec playerctl play-pause
bindsym $mod+F3 exec playerctl play-pause
bindsym XF86AudioNext exec playerctl next
bindsym XF86AudioPrev exec playerctl previous
# could be redundant, if I find a way to fix a bug with audio on the phone stopping at times with headphones connected to pc too.
bindsym $mod+b exec bluetoothctl connect E8:EE:CC:36:53:49
bindsym $mod+Shift+b exec bluetoothctl disconnect E8:EE:CC:36:53:49
#

# # Redshift
# calibrated so it takes 20 key presses for both temperature and brightness to move between the two default states.
bindsym $mod+F9 exec gdbus call -e -d net.zoidplex.wlr_gamma_service -o /net/zoidplex/wlr_gamma_service -m net.zoidplex.wlr_gamma_service.temperature.decrease 210 && gdbus call -e -d net.zoidplex.wlr_gamma_service -o /net/zoidplex/wlr_gamma_service -m net.zoidplex.wlr_gamma_service.brightness.decrease 0.0275
bindsym $mod+F10 exec gdbus call -e -d net.zoidplex.wlr_gamma_service -o /net/zoidplex/wlr_gamma_service -m net.zoidplex.wlr_gamma_service.temperature.increase 210 && gdbus call -e -d net.zoidplex.wlr_gamma_service -o /net/zoidplex/wlr_gamma_service -m net.zoidplex.wlr_gamma_service.brightness.increase 0.0275
bindsym $mod+Shift+F9 exec gdbus call -e -d net.zoidplex.wlr_gamma_service -o /net/zoidplex/wlr_gamma_service -m net.zoidplex.wlr_gamma_service.temperature.set 2300 && gdbus call -e -d net.zoidplex.wlr_gamma_service -o /net/zoidplex/wlr_gamma_service -m net.zoidplex.wlr_gamma_service.brightness.set 0.45
bindsym $mod+Shift+F10 exec gdbus call -e -d net.zoidplex.wlr_gamma_service -o /net/zoidplex/wlr_gamma_service -m net.zoidplex.wlr_gamma_service.temperature.set 6500 && gdbus call -e -d net.zoidplex.wlr_gamma_service -o /net/zoidplex/wlr_gamma_service -m net.zoidplex.wlr_gamma_service.brightness.set 1
exec_always sudo killall auto_redshift
exec_always sleep 2 && auto_redshift 7:00
#

#TODO!: is there a way to explicitly bind ws0 to the tasks that are kept visible only for their log, but are not expected to fail? (or should I just make a bash command to record these into some automatically named log file in tmp? Should be 2-4 extra characters to evoke max)
# # Workspaces
# bug on sway's side; can't set wallpaper if it's not preset.
output * bg ~/Wallpapers/AndreySakharov.jpg fill
workspace 1 output $primary
workspace 2 output $primary
workspace 3 output $primary
workspace 4 output $primary
workspace 5 output $primary
workspace 6 output $primary
workspace 7 output $primary
workspace 8 output $output_laptop
workspace 9 output $output_laptop
workspace 0 output $primary
bindsym $mod+1   workspace 1
bindsym $mod+2   workspace 2
bindsym $mod+3   workspace 3
bindsym $mod+4   workspace 4
bindsym $mod+5   workspace 5
bindsym $mod+6   workspace 6
bindsym $mod+7   workspace 7
bindsym $mod+8   workspace 8
bindsym $mod+9   workspace 9
bindsym $mod+0   workspace 0
bindsym $mod+Shift+1    move container to workspace 1
bindsym $mod+Shift+2    move container to workspace 2
bindsym $mod+Shift+3    move container to workspace 3
bindsym $mod+Shift+4    move container to workspace 4
bindsym $mod+Shift+5    move container to workspace 5
bindsym $mod+Shift+6    move container to workspace 6
bindsym $mod+Shift+7    move container to workspace 7
bindsym $mod+Shift+8    move container to workspace 8
bindsym $mod+Shift+9    move container to workspace 9
bindsym $mod+Shift+0    move container to workspace 0

assign [class="Google-chrome"] 2
assign [class="discord"] 4
assign [class="Zulip"] 4
assign [app_id="org.telegram.desktop"] 4
# doesn't work, as netrw sets the title as "nvim: [No name]"
#assign [app_id="Alacritty" title="nvim: ~/Todo*$"] 4
exec "~/.config/sway/restore_session.sh"

bindsym Mod1+Tab focus prev
bindsym Mod1+f focus next

bindsym $mod+$left resize grow width 6ppt
bindsym $mod+$down resize shrink height 6ppt
bindsym $mod+$up resize grow height 6ppt
bindsym $mod+$right resize shrink width 6ppt

bindsym $mod+Shift+$left move left
bindsym $mod+Shift+$down move down
bindsym $mod+Shift+$up move up
bindsym $mod+Shift+$right move right

bindsym $mod+c kill
bindsym $mod+Return exec alacritty
bindsym $mod+z floating toggle
bindsym $mod+Shift+z sticky toggle
# allows 1) moving by holding $mod + mouse_left_click + moving mouse 2) resizing by holding $mod + mouse_right_click + moving mouse
floating_modifier $mod normal
#

bindsym $mod+j reload
# the first command gracefully exits chrome, which is apparently very sensitive.
#bindsym $mod+q exec "pkill -TERM -x chrome; sudo shutdown -h now"
bindsym $mod+Shift+q exec "eww update sway_mode=full_upgrade_before_shutdown && ${HOME}/s/help_scripts/boring.sh && sleep 1 && pkill -TERM -x chrome; sudo shutdown -h now"

#bindsym $mod+l exec $lock
bindsym $mod+Escape exec $power
bindsym $mod+End exec $wifi




bindsym $mod+m exec $menu
bindsym $mod+Space exec makoctl dismiss --all
bindsym $mod+o split vertical
bindsym $mod+Shift+o split horizontal
bindsym $mod+Ctrl+t layout tabbed
bindsym $mod+f fullscreen
bindsym $mod+p focus parent
bindsym $mod+minus scratchpad show
bindsym $mod+Shift+minus move scratchpad
bindsym Ctrl+Shift+Escape exec alacritty --class btm-float -e btm -u; for_window [app_id="btm-float"] floating enable
bindsym $mod+d exec ~/.config/sway/discord_toggle.sh
bindsym $mod+Mod1+t exec ~/s/help_scripts/theme_toggle.sh

set $refresh_eww "eww kill; eww open bar; eww open bar1"
exec_always $refresh_eww
bindsym $mod+e exec ~/.config/sway/eww_zoom_toggle.sh
bindsym $mod+Shift+e exec ~/.config/sway/eww_visibility_toggle.sh
bindsym $mod+Ctrl+e exec $refresh_eww

# check if any task was cut short during the last session
exec_always sleep 3 && todo do continue_ongoing

#TODO: make into a toggle
#bindcode $mod+34 exec ~/.configlsway/toggle_screen.sh
bindcode $mod+34 output $output_laptop dpms on
bindcode $mod+Shift+34 output $output_laptop dpms off
#bindcode $mod+Control+34 exec ~/.config/sway/toggle_screen.sh DP-1

# # Modes
set $switch_out swaymsg mode \"default\" && eww update sway_mode=default

# Outputs
output $output_monitor pos 0 0 scale 0.73684
#output $output_laptop pos 277 1080
# these are scaled by 1/0.73684 (which is the current `scale` on the large monitor screen)
output $output_laptop pos 376 1466

exec_always "sh -c -- pkill -f 'todo_monitor' && todo monitor || todo monitor"


bindsym $mod+w exec "~/s/help_scripts/circle_wallpapers.sh f"
bindsym $mod+Shift+w exec "~/s/help_scripts/circle_wallpapers.sh b"

# Screenshots
set $throwaway_screenshot slurp | grim -g - ~/tmp/Screenshots/scrn-$(date +"%Y-%m-%d-%H-%M-%S").png && swappy -f ~/tmp/Screenshots/$(ls -t ~/tmp/Screenshots | awk 'NR==1 {print; exit}')
bindsym Insert exec $throwaway_screenshot
mode "screenshot" {
	set $fullscreen_screenshot grim ~/tmp/Screenshots/scrn-$(date +"%Y-%m-%d-%H-%M-%S").png && swappy -f ~/tmp/Screenshots/$(ls -t ~/tmp/Screenshots | awk 'NR==1 {print; exit}')
	set $delayed_screenshot sleep 3 && slurp | grim -g - ~/tmp/Screenshots/scrn-$(date +"%Y-%m-%d-%H-%M-%S").png && swappy -f ~/tmp/Screenshots/$(ls -t ~/tmp/Screenshots | awk 'NR==1 {print; exit}')
	set $important_screenshot slurp | grim -g - ~/Images/Screenshots/scrn-$(date +"%Y-%m-%d-%H-%M-%S").png && swappy -f ~/Images/Screenshots/$(ls -t ~/Images/Screenshots | awk 'NR==1 {print; exit}')
	set $open_last_screenshot swappy -f ~/Images/Screenshots/$(ls -t ~/Images/Screenshots | awk 'NR==1 {print; exit}')

	bindsym i exec $switch_out && $important_screenshot
	# doesn't work for some reason
	bindsym f exec $switch_out && $fullscrseen_screenshot
	bindsym d exec $switch_out && $delayed_screenshot
	bindsym o exec $switch_out && $open_last_screenshot
	bindsym Insert exec $switch_out && throwaway_screenshot

	bindsym $mod+Insert exec $switch_out
	bindsym $mod+c exec $switch_out
	bindsym Ctrl+c exec $switch_out
	bindsym Escape exec $switch_out
	bindsym q exec $switch_out
}
bindsym $mod+Insert exec "swaymsg mode screenshot && eww update sway_mode=screenshot"

# Set window sizes
mode "size_presets" {
	bindsym 1 resize set 350px 650px
	bindsym 2 resize set 576px 768px
	bindsym 3 resize set 768px 768px
	bindsym 4 resize set 992px 768px
	bindsym 5 resize set 1200px 768px

	bindsym $left move left
	bindsym $down move down
	bindsym $up move up
	bindsym $right move right


	bindsym $mod+apostrophe exec $switch_out
	bindsym $mod+c exec $switch_out
	bindsym Ctrl+c exec $switch_out
	bindsym Escape exec $switch_out
	bindsym q exec $switch_out
}
bindsym $mod+apostrophe exec "swaymsg mode size_presets && eww update sway_mode=size_presets"
#
